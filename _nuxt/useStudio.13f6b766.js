import{ag as x,ab as R,L as $,aq as L,ao as U,ar as P,as as _,m as A,at as T,ap as b,J as k}from"./entry.85a08847.js";import N from"./ContentPreviewMode.2edf22a1.js";/* empty css                                                                           */const j=(u,p,v)=>{const a=[...p||[]],m=[...v||[]],n=[...u||[]];for(const e of a)if(e.oldPath)if(m.splice(m.findIndex(s=>s.path===e.oldPath),1),a.find(s=>s.path===e.oldPath))n.push({path:e.path,parsed:e.parsed});else{const s=n.find(c=>c.path===e.oldPath);s&&(s.path=e.path,e.parsed?s.parsed=e.parsed:e.pathMeta&&["_file","_path","_id","_locale"].forEach(c=>{s.parsed[c]=e.pathMeta[c]}))}else if(e.new)n.push({path:e.path,parsed:e.parsed});else{const r=n.find(s=>s.path===e.path);r&&Object.assign(r,{path:e.path,parsed:e.parsed})}for(const e of m)n.splice(n.findIndex(r=>r.path===e.path),1);return n},O=u=>{let p;return(...v)=>(p||(p=u()),p)},S=O(()=>JSON.parse(JSON.stringify(k()))),W=()=>{const u=x(),p=R().public.studio||{},v=S(),a=U("pinceauTheme"),m=a&&(a==null?void 0:a.theme)?a.theme.value:{},n=$("client-db",()=>null),e=L("previewToken",{sameSite:"none",secure:!0}),r=async(t,i,o=!0)=>{const f=await t.getKeys(`${e.value}:`);await Promise.all(f.map(d=>t.removeItem(d))),await t.setItem(`${e.value}$`,JSON.stringify({ignoreBuiltContents:o})),await Promise.all(i.map(d=>{var h;return t.setItem(`${e.value}:${(h=d.parsed)==null?void 0:h._id}`,JSON.stringify(d.parsed))}))},s=t=>{P(u,_,[t||v])},c=t=>{!a||!(a!=null&&a.updateTheme)||P(u,a.updateTheme,t||m)},g=async t=>{const i=await $fetch("api/projects/preview",{baseURL:p.apiURL,params:{token:e.value}}),o=j(i.files,i.additions,i.deletions),f=o.filter(l=>l.path.startsWith("content"));await r(t,f,(i.files||[]).length!==0);const d=o.filter(l=>l.path.startsWith(".studio")),h=d.find(l=>l.path===".studio/app.config.json");s(h==null?void 0:h.parsed);const w=d.find(l=>l.path===".studio/tokens.config.json");c(w==null?void 0:w.parsed)},y=async()=>{await $fetch("api/projects/preview/sync",{baseURL:p.apiURL,method:"POST",params:{token:e.value}})},C=t=>{const i=A(()=>!!t.value),o=document.createElement("div");o.id="__nuxt_preview_wrapper",document.body.appendChild(o),T(N,{previewToken:e,apiURL:p.apiURL,storageReady:i,refresh:()=>g(t.value).then(()=>b()),init:y}).mount(o)},I=async t=>{var o,f;if(!t)return null;t=t.replace(/\/$/,"");let i=await((o=n.value)==null?void 0:o.getItem(`${e.value}:${t}`));return i||(i=await((f=n.value)==null?void 0:f.getItem(t))),i};return{apiURL:p.apiURL,previewToken:e,contentStorage:n,syncPreview:g,syncPreviewFiles:r,syncPreviewAppConfig:s,syncPreviewTokensConfig:c,requestPreviewSynchronization:y,mountPreviewUI:C,findContentWithId:I}};export{W as useStudio};
